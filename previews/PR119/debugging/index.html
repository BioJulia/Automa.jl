<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Debugging Automa · Automa.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Automa.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../theory/">Theory</a></li><li><a class="tocitem" href="../regex/">Regex</a></li><li><a class="tocitem" href="../validators/">Validators</a></li><li><a class="tocitem" href="../tokenizer/">Tokenizers</a></li><li><a class="tocitem" href="../parser/">Parsing buffers</a></li><li><a class="tocitem" href="../custom/">Customizing codegen</a></li><li><a class="tocitem" href="../io/">Parsing IOs</a></li><li><a class="tocitem" href="../reader/">Creating readers</a></li><li class="is-active"><a class="tocitem" href>Debugging Automa</a><ul class="internal"><li><a class="tocitem" href="#Revise"><span>Revise</span></a></li><li><a class="tocitem" href="#Ambiguity-check"><span>Ambiguity check</span></a></li><li><a class="tocitem" href="#Create-Machine-flowchart"><span>Create <code>Machine</code> flowchart</span></a></li><li><a class="tocitem" href="#Running-machines-in-debug-mode"><span>Running machines in debug mode</span></a></li><li><a class="tocitem" href="#More-advanced-debuggning"><span>More advanced debuggning</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Debugging Automa</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Debugging Automa</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/BioJulia/Automa.jl/blob/master/docs/src/debugging.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Debugging-Automa"><a class="docs-heading-anchor" href="#Debugging-Automa">Debugging Automa</a><a id="Debugging-Automa-1"></a><a class="docs-heading-anchor-permalink" href="#Debugging-Automa" title="Permalink"></a></h1><div class="admonition is-danger"><header class="admonition-header">Danger</header><div class="admonition-body"><p>All Automa&#39;s debugging tools are NOT part of the API and are subject to change without warning. You can use them during development, but do NOT rely on their behaviour in your final code.</p></div></div><p>Automa is a complicated package, and the process of indirectly designing parsers by first designing a machine can be error prone. Therefore, it&#39;s crucial to have good debugging tooling.</p><h2 id="Revise"><a class="docs-heading-anchor" href="#Revise">Revise</a><a id="Revise-1"></a><a class="docs-heading-anchor-permalink" href="#Revise" title="Permalink"></a></h2><p>Revise is not able to update Automa-generated functions. To make your feedback loop faster, you can manually re-run the code that defines the Automa functions - usually this is much faster than modifying the package and reloading it.</p><h2 id="Ambiguity-check"><a class="docs-heading-anchor" href="#Ambiguity-check">Ambiguity check</a><a id="Ambiguity-check-1"></a><a class="docs-heading-anchor-permalink" href="#Ambiguity-check" title="Permalink"></a></h2><p>It is easy to accidentally create a machine where it is undecidable what actions should be taken. For example:</p><pre><code class="language-julia">machine = let
    alphabet = re&quot;BC&quot;
    band = onenter!(re&quot;BBA&quot;, :cool_band)
    compile(re&quot;XYZ A&quot; * (alphabet | band))
end

# output
ERROR: Ambiguous NFA.
[...]</code></pre><p>Consider what the machine should do once it observes the two first bytes <code>AB</code> of the input: Is the <code>B</code> part of <code>alphabet</code> (in which case it should do nothing), or is it part of <code>band</code> (in which case it should do the action <code>:cool_band</code>)? It&#39;s impossible to tell.</p><p>Automa will not compile this, and will raise the error:</p><pre><code class="language-none">ERROR: Ambiguous NFA.</code></pre><p>Note the error shows an example input which will trigger the ambiguity: <code>XYZ A</code>, then <code>B</code>. By simply running the input through in your head, you may discover yourself how the error happens.</p><p>In the example above, the error was obvious, but consider this example:</p><pre><code class="language-julia">fasta_machine = let
    header = re&quot;[a-z]+&quot;
    seq_line = re&quot;[ACGT]+&quot;
    sequence = seq_line * rep(&#39;\n&#39; * seq_line)
    record = onexit!(&#39;&gt;&#39; * header * &#39;\n&#39; * sequence, :emit_record)
    compile(rep(record * &#39;\n&#39;) * opt(record))
end

# output
ERROR: Ambiguous NFA.
[...]</code></pre><p>It&#39;s the same problem: After a sequence line you observe <code>\n</code>: Is this the end of the sequence, or just a newline before another sequence line?</p><p>To work around it, consider when you know <em>for sure</em> you are out of the sequence: It&#39;s not before you see a new <code>&gt;</code>, or end-of-file. In a sense, the trailing <code>\n</code> really IS part of the sequence. So, really, your machine should regex similar to this</p><pre><code class="language-julia">fasta_machine = let
    header = re&quot;[a-z]+&quot;
    seq_line = re&quot;[ACGT]+&quot;
    sequence = rep1(seq_line * &#39;\n&#39;)
    record = onexit!(&#39;&gt;&#39; * header * &#39;\n&#39; * sequence, :emit_record)

    # A special record that can avoid a trailing newline, but ONLY if it&#39;s the last record
    record_eof = &#39;&gt;&#39; * header * &#39;\n&#39; * seq_line * rep(&#39;\n&#39; * seq_line) * opt(&#39;\n&#39;)
    compile(rep(record * &#39;\n&#39;) * opt(record_eof))
end
@assert fasta_machine isa Automa.Machine

# output</code></pre><p>When all else fails, you can also pass <code>unambiguous=false</code> to the <code>compile</code> function - but beware! Ambiguous machines has undefined behaviour if you get into an ambiguous situation.</p><h2 id="Create-Machine-flowchart"><a class="docs-heading-anchor" href="#Create-Machine-flowchart">Create <code>Machine</code> flowchart</a><a id="Create-Machine-flowchart-1"></a><a class="docs-heading-anchor-permalink" href="#Create-Machine-flowchart" title="Permalink"></a></h2><p>The function <code>machine2dot(::Machine)</code> will return a string with a Graphviz <code>.dot</code> formatted flowchart of the machine. Graphviz can then convert the dot file to an SVG function.</p><p>On my computer (with Graphviz and Firefox installed), I can use the following Julia code to display a flowchart of a machine. Note that <code>dot</code> is the command-line name of Graphviz.</p><pre><code class="language-julia">function display_machine(m::Machine)
    open(&quot;/tmp/machine.dot&quot;, &quot;w&quot;) do io
        println(io, Automa.machine2dot(m))
    end
    run(pipeline(`dot -Tsvg /tmp/machine.dot`, stdout=&quot;/tmp/machine.svg&quot;))
    run(`firefox /tmp/machine.svg`)
end</code></pre><p>The following function are Automa internals, but they might help with more advanced debugging:</p><ul><li><code>re2nfa</code> - create an NFA from an Automa regex</li><li><code>nfa2dot</code> - create a dot-formatted string from an nfa</li><li><code>nfa2dfa</code> - create a DFA from an NFA</li><li><code>dfa2dot</code> - create a dot-formatted string from a DFA</li></ul><h2 id="Running-machines-in-debug-mode"><a class="docs-heading-anchor" href="#Running-machines-in-debug-mode">Running machines in debug mode</a><a id="Running-machines-in-debug-mode-1"></a><a class="docs-heading-anchor-permalink" href="#Running-machines-in-debug-mode" title="Permalink"></a></h2><p>The function <code>generate_code</code> takes an argument <code>actions</code>. If this is <code>:debug</code>, then all actions in the given <code>Machine</code> will be replaced by <code>:(push!(logger, action_name))</code>. Hence, given a FASTA machine, you could create a debugger function:</p><pre><code class="language-julia"> @eval function debug(data)
    logger = []
    $(generate_code(fasta_machine, :debug))
    logger
end</code></pre><p>Then see all the actions executed in order, by doing:</p><pre><code class="language-julia">julia&gt; debug(&quot;&gt;abc\nTAG&quot;)
4-element Vector{Any}:
 :mark
 :header
 :mark
 :seqline
 :record</code></pre><p>Note that if your machine relies on its actions to work correctly, for example by actions modifying <code>p</code>, this kind of debugger will not work, as it replaces all actions.</p><h2 id="More-advanced-debuggning"><a class="docs-heading-anchor" href="#More-advanced-debuggning">More advanced debuggning</a><a id="More-advanced-debuggning-1"></a><a class="docs-heading-anchor-permalink" href="#More-advanced-debuggning" title="Permalink"></a></h2><p>The file <code>test/debug.jl</code> contains extra debugging functionality and may be <code>include</code>d. In particular it defines the functions <code>debug_execute</code> and <code>create_debug_function</code>.</p><p>The function of <code>create_debug_function(::Machine; ascii=false)</code> is best demonstrated:</p><pre><code class="language-julia">machine = let
    letters = onenter!(re&quot;[a-z]+&quot;, :enter_letters)
    compile(onexit!(letters * re&quot;,[0-9],&quot; * letters, :exiting_regex))
end
eval(create_debug_function(machine; ascii=true))
(end_state, transitions) = debug_compile(&quot;abc,5,d!&quot;)
@show end_state
transitions</code></pre><p>Will create the following output:</p><pre><code class="language-none">end state = -6
7-element Vector{Tuple{Char, Int64, Vector{Symbol}}}:
 (&#39;a&#39;, 2, [:enter_letters])
 (&#39;b&#39;, 2, [])
 (&#39;c&#39;, 2, [])
 (&#39;,&#39;, 3, [])
 (&#39;5&#39;, 4, [])
 (&#39;,&#39;, 5, [])
 (&#39;d&#39;, 6, [:enter_letters])</code></pre><p>Where each 3-tuple in the input corresponds to the input byte (displayed as a <code>Char</code> if <code>ascii</code> is set to <code>true</code>), the Automa state reached on reading the letter, and the actions executed.</p><p>The <code>debug_execute</code> function works the same as the <code>debug_compile</code>, but does not need to be generated first, and can be run directly on an Automa regex:</p><pre><code class="language-julia">julia&gt; debug_execute(re&quot;[A-z]+&quot;, &quot;abc1def&quot;; ascii=true)
(-3, Tuple{Union{Nothing, Char}, Int64, Vector{Symbol}}[(&#39;a&#39;, 2, []), (&#39;b&#39;, 3, []), (&#39;c&#39;, 3, [])])</code></pre><article class="docstring"><header><a class="docstring-binding" id="Automa.machine2dot" href="#Automa.machine2dot"><code>Automa.machine2dot</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia">machine2dot(machine::Machine)::String</code></pre><p>Return a String with a flowchart of the machine in Graphviz (dot) format. Using <code>Graphviz</code>, a command-line tool, the dot file can be converted to various picture formats.</p><p><strong>Example</strong></p><pre><code class="language-julia">open(&quot;/tmp/machine.dot&quot;, &quot;w&quot;) do io
    println(io, machine2dot(machine))
end
# Requires graphviz to be installed
run(pipeline(`dot -Tsvg /tmp/machine.dot`), stdout=&quot;/tmp/machine.svg&quot;)</code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/BioJulia/Automa.jl/blob/c91a1933def891cefdd98a6ae1dbcb6a8d9255f8/src/dot.jl#L42-L57">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../reader/">« Creating readers</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Wednesday 19 July 2023 07:07">Wednesday 19 July 2023</span>. Using Julia version 1.9.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
